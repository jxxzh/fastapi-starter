# AGENTS.md

这是一个 FastAPI 项目的 AI 编码代理指南。

## 项目概述

这是一个基于 FastAPI 的现代化 Python Web 应用，采用渐进式架构设计，使用 uv 作为包管理工具，Pydantic v2 进行数据验证，集成了完整的日志、错误处理和中间件系统。

## 设置命令

- **安装依赖**: `uv sync`
- **启动开发服务器**: `uv run dev` （自动热重载）
- **生产环境运行**: `uv run uvicorn server.main:app --host 0.0.0.0 --port 8000`
- **代码格式化**: `uv run ruff format .`
- **代码检查**: `uv run ruff check .`

## 项目结构

```
fastapi-starter/
├── server/                    # 主应用目录
│   ├── core/                 # 核心基础设施
│   │   ├── config.py        # 配置管理（使用 Pydantic Settings）
│   │   ├── logger.py        # 日志配置（使用 Loguru）
│   │   ├── handlers/        # 异常处理器
│   │   ├── middlewares/     # 中间件（request_id, logging 等）
│   │   └── decorators/      # 装饰器（response_wrapper 等）
│   ├── routers/             # API 路由模块
│   ├── schemas/             # Pydantic 数据模型
│   └── main.py             # FastAPI 应用入口
├── logs/                    # 日志目录
├── .env(.env.dev,.env.prod)                    # 环境变量
├── pyproject.toml          # 项目配置
└── uv.lock                 # 锁定的依赖版本
└── README.md               # 项目说明文档
```

## Python 代码风格和原则

### 核心原则

- **函数式编程**: 优先使用函数和模块化设计，避免不必要的类
  - 函数设计遵循单一职责原则
  - 纯函数和不可变数据结构优先，避免副作用
  - 函数定义时，善用仅限关键字参数（单独的`*`），确保位置参数精简
- **声明式编程**: 优先使用声明式而非命令式编程风格
- **类型提示**: 所有函数签名必须包含完整的类型提示
- **代码复用**: 通过迭代和模块化避免代码重复

### 命名规范

- **变量名**: 使用小写加下划线，使用描述性名称和辅助动词（如 `is_active`, `has_permission`）
- **文件/目录**: 使用小写加下划线（如 `routers/user_routes.py`）
- **导出**: 优先使用命名导出

### 数据模型

- **使用 Pydantic v2**: 所有数据验证和响应模式使用 Pydantic 的 `BaseModel`
- **类型安全**: 优先使用 Pydantic 模型而非原始字典进行输入验证
- **一致性**: 使用 Pydantic 的 BaseModel 确保输入/输出验证和响应模式的一致性

## FastAPI 应用规则

### 应用结构 (main.py)

- **函数式组件**: 使用纯函数和 Pydantic 模型进行输入验证和响应模式
- **声明式路由**: 使用清晰的返回类型注解定义路由
- **同步/异步**: 根据操作类型使用 `def`（同步）或 `async def`（异步）
- **生命周期管理**: 使用 lifespan 上下文管理器，最小化 `@app.on_event("startup")` 和 `@app.on_event("shutdown")`
- **中间件**: 使用中间件处理日志、错误监控和性能优化
- **异常处理**: 使用 `HTTPException` 处理预期错误，并将其建模为特定的 HTTP 响应

### 路由结构 (routers/)

- **文件结构**: 导出的路由器、子路由、工具函数、静态内容、类型（模型、模式）
- **简洁条件**: 避免不必要的花括号，使用简洁的单行语法处理简单条件（如 `if condition: do_something()`）
- **清晰结构**: 清晰地组织路由和依赖项，优化可读性和可维护性

## 错误处理规则

### 核心原则

- **优先处理错误**: 在函数开头处理错误和边界情况
- **早期返回**: 对错误条件使用早期返回，避免深度嵌套的 if 语句
- **快乐路径最后**: 将函数的正常执行路径放在最后，提高可读性
- **避免 else**: 使用 if-return 模式，避免不必要的 else 语句
- **守卫子句**: 使用守卫子句及早处理前置条件和无效状态
- **完善日志**: 实现适当的错误日志记录和用户友好的错误消息
- **自定义错误**: 使用自定义错误类型或错误工厂实现一致的错误处理

## 性能优化规则

### 核心原则

- **最小化阻塞 I/O**: 对所有数据库调用和外部 API 请求使用异步操作
- **实现缓存**: 使用 Redis 或内存存储缓存静态和频繁访问的数据
- **优化序列化**: 使用 Pydantic 优化数据序列化和反序列化
- **懒加载**: 对大型数据集和大量 API 响应使用懒加载技术
- **性能指标**: 优先考虑 API 性能指标（响应时间、延迟、吞吐量）
- **非阻塞流**: 在路由中限制阻塞操作，优先使用异步和非阻塞流
- **专用异步函数**: 对数据库和外部 API 操作使用专用异步函数

## 数据库交互规则

### 核心原则

- **异步数据库库**: 使用 `asyncpg`、`aiomysql` 等异步数据库库
- **SQLAlchemy 2.0**: 如果使用 ORM 功能，使用 SQLAlchemy 2.0
- **专用异步函数**: 对数据库和外部 API 操作使用专用异步函数
